<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">
    <meta name="description" content="My site, made with PWA Easy">
    <meta name="theme-color" content="#317EFB"/>
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="apple-touch-icon" href="img/logo-pwa-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">
    <link rel="shortcut icon" href="img/favicon.ico" />
    <title>My site!</title>
    <style id="styles-temporary">
        body * {
            display: none;
        }

        #app-loading {
            display: initial;
            background: url("img/loading.svg") no-repeat center center;
            margin: auto;
            width: 50vh;
            height: 50vh;
        }

        #app {
            width: 100%;
            height: 100vh;
            display: flex;
        }

        noscript {
            display: initial;
        }
    </style>
</head>
<body>
<noscript>
    Please enable JavaScript to access this site.
</noscript>

<div id="app" style="display: none">
    <div id="app-loading"></div>
</div>

<script type="text/x-template" id="app-template"></script>

<script type="module">
    document.getElementById('app').removeAttribute('style');

    import './config/globals.js';

    const sleep = ms => new Promise(resolve => { setTimeout(resolve, ms) });

    (async () => {
        const startApp = async () => {
            let {default: ControllerIndex} = await import('./controllers/index.js');
            await ControllerIndex.initialize();
        };

        if ('serviceWorker' in window.navigator) {
            const Workbox = 'localhost' === window.location.hostname
                ? (await import('./external/js/global/workbox/workbox-window.dev.mjs')).Workbox
                : (await import('./external/js/global/workbox/workbox-window.prod.mjs')).Workbox;

            const wb = new Workbox(`${config.rootURL.pathname}service-worker.js`, {updateViaCache: 'none'});

            wb.addEventListener('installed', event => { if (event.isUpdate) app?.showUpdateSnackbar(); });
            wb.addEventListener('externalactivated', () => { app?.showUpdateSnackbar(); });

            await wb.register();

            // Workaround for the lack of an 'activated' event. The app requires the ServiceWorker when there is
            // no internet access. The ServiceWorker also performs various URL rewrites to reduce the network usage.
            // https://github.com/w3c/ServiceWorker/issues/1222
            // https://github.com/w3c/ServiceWorker/issues/1247
            const swr = await window.navigator.serviceWorker.ready;
            while (swr.active.state !== 'activated') await sleep(0);
            await startApp();
        } else await startApp(); // fall back to online-only mode
    })();
</script>
</body>
</html>